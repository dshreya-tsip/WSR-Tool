<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NW Team Weekly Status Report</title>
  <link rel="stylesheet" 
  href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <style>
    body { background: #f8f9fa; }
    #loginForm {
      max-width: 400px; margin: 100px auto; background: white;
      padding: 30px; border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    #wsrTable td input, #wsrTable td textarea, #wsrTable td select {
      width: 100%; box-sizing: border-box; font-size: 14px;
      font-family: inherit; border: none;
      background-color: transparent; resize: none; pointer-events: none;
    }
    #wsrTable td textarea { min-height: 60px; overflow: hidden; }
    #wsrTable td:nth-child(1), #wsrTable th:nth-child(1) {
      width: 260px; text-align: center; vertical-align: middle;
    }
    .custom-header th {
      background-color: #343a40; color: white; text-align: center; vertical-align: middle;
    }
    .custom-save-btn { background-color: #12d536; color: white; border: none; }
    .custom-save-btn:hover { background-color: #12d536; }
    .custom-add-btn { background-color: #0066a1; color: white; border: none; }
    .custom-add-btn:hover { background-color: #0066a1; }
    #mainApp { padding: 20px; }
    #logoutBtn { position: absolute; top: 0; right: 0; }
    td.actions-cell { text-align: center; vertical-align: middle; white-space: nowrap; }
    td.actions-cell button { margin: 0 5px; min-width: 60px; }
    tr.editing td input, tr.editing td textarea, tr.editing td select {
      pointer-events: auto; background-color: white;
      border: 1px solid #ced4da; border-radius: 4px;
    }
    /* Date multi-picker styles */
    .date-badge {
      display: inline-block;
      background: #e6f2ff;
      color: #0066a1;
      border-radius: 8px;
      padding: 2px 8px;
      margin: 2px;
      font-size: 13px;
    }
    .date-badge .remove {
      cursor: pointer;
      margin-left: 4px;
      color: #d9534f;
    }
  </style>
</head>
<body>
  <!-- Login Form -->
  <div id="loginForm">
    <h3 class="text-center mb-4">Login to NW Team WSR</h3>
    <div class="form-group">
      <label for="username">Username</label>
      <input type="text" id="username" class="form-control" />
    </div>
    <div class="form-group">
      <label for="password">Password</label>
      <input type="password" id="password" class="form-control" />
    </div>
    <button class="btn btn-primary btn-block" onclick="handleLogin()">Login</button>
  </div>

  <!-- Main Application -->
  <div id="mainApp" style="display: none; position: relative;">
    <div class="text-center mb-3" style="position: relative;">
      <h2 class="mb-0">NW Weekly Status Report</h2>
      <button id="logoutBtn" class="btn btn-outline-danger" onclick="handleLogout()">Logout</button>
    </div>
    <table id="wsrTable" class="table table-bordered">
      <thead class="custom-header">
        <tr id="tableHeaderRow">
          <th>Week Days</th>
          <th>Etria(Activity)</th>
          <th>Solutions(Activity)</th>
          <th>Meeting Summary</th>
          <!-- Actions header only if admin -->
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="btn custom-add-btn" id="addRowBtn" onclick="addRow()">Add Row</button>
    <button class="btn custom-save-btn" id="saveBtn" onclick="saveTable()">Save</button>
  </div>
  <script>
    let currentRole = "";
    let editingRow = null;

    function handleLogin() {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();

      if ((username === "admin" && password === "admin123") ||
          (username === "user" && password === "user123")) {

        currentRole = username === "admin" ? "admin" : "user";
        document.getElementById("loginForm").style.display = "none";
        document.getElementById("mainApp").style.display = "block";

        const headerRow = document.getElementById("tableHeaderRow");
        if (currentRole === "user") {
          document.getElementById("addRowBtn").style.display = "none";
          document.getElementById("saveBtn").style.display = "none";
          if (headerRow.children.length === 5) {
            headerRow.removeChild(headerRow.lastElementChild);
          }
        } else {
          document.getElementById("addRowBtn").style.display = "inline-block";
          document.getElementById("saveBtn").style.display = "inline-block";
          if (headerRow.children.length === 4) {
            const th = document.createElement("th");
            th.textContent = "Actions";
            headerRow.appendChild(th);
          }
        }

        document.querySelector("#wsrTable tbody").innerHTML = "";
      } else {
        alert("Invalid username or password.");
      }
    }

    function handleLogout() {
      currentRole = "";
      editingRow = null;
      document.getElementById("mainApp").style.display = "none";
      document.getElementById("loginForm").style.display = "block";
      document.querySelector("#wsrTable tbody").innerHTML = "";
      document.getElementById("addRowBtn").style.display = "inline-block";
      document.getElementById("saveBtn").style.display = "inline-block";
      const headerRow = document.getElementById("tableHeaderRow");
      if (headerRow.children.length === 4) {
        const th = document.createElement("th");
        th.textContent = "Actions";
        headerRow.appendChild(th);
      }
      document.getElementById("username").value = "";
      document.getElementById("password").value = "";
    }

    function autoResize(textarea) {
      textarea.style.height = "auto";
      textarea.style.height = textarea.scrollHeight + "px";
    }

    // Util: format date yyyy-mm-dd to dd MMM yyyy
    function formatDate(dateString) {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return "";
      return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function addRow(data = [[], "", "", ""]) {
      const tbody = document.querySelector("#wsrTable tbody");
      const row = tbody.insertRow();
      const colsCount = currentRole === "admin" ? 5 : 4;

      for (let index = 0; index < colsCount; index++) {
        const cell = row.insertCell();

        if (index === 0) {
          // Week Days: Multi-date picker
          cell.style.textAlign = "center";
          // Container for badges
          const badgesDiv = document.createElement("div");
          badgesDiv.className = "badges-container";
          cell.appendChild(badgesDiv);

          // Hidden input to store dates (array)
          const hiddenInput = document.createElement("input");
          hiddenInput.type = "hidden";
          hiddenInput.value = JSON.stringify(data[0] || []);
          cell.appendChild(hiddenInput);

          // Date picker
          const dateInput = document.createElement("input");
          dateInput.type = "date";
          dateInput.style.marginTop = "8px";
          dateInput.style.display = "none";
          cell.appendChild(dateInput);

          // Add Date button
          const addDateBtn = document.createElement("button");
          addDateBtn.textContent = "Add Date";
          addDateBtn.type = "button";
          addDateBtn.className = "btn btn-outline-primary btn-sm";
          addDateBtn.style.marginTop = "8px";
          addDateBtn.onclick = function() {
            dateInput.style.display = "inline-block";
            dateInput.focus();
          };
          cell.appendChild(addDateBtn);

          // Render badges
          function renderBadges() {
            badgesDiv.innerHTML = "";
            const dates = JSON.parse(hiddenInput.value || "[]");
            dates.forEach((d, i) => {
              const badge = document.createElement("span");
              badge.className = "date-badge";
              badge.textContent = formatDate(d);
              const remove = document.createElement("span");
              remove.className = "remove";
              remove.textContent = "Ã—";
              remove.title = "Remove";
              remove.onclick = function () {
                const arr = JSON.parse(hiddenInput.value || "[]");
                arr.splice(i, 1);
                hiddenInput.value = JSON.stringify(arr);
                renderBadges();
              };
              badge.appendChild(remove);
              badgesDiv.appendChild(badge);
            });
          }
          renderBadges();

          dateInput.onchange = function() {
            let arr = JSON.parse(hiddenInput.value || "[]");
            if (arr.length >= 5) {
              alert("You can select a maximum of 5 dates.");
              dateInput.value = "";
              dateInput.style.display = "none";
              return;
            }
            if (arr.includes(dateInput.value)) {
              alert("This date is already selected.");
            } else if (dateInput.value) {
              arr.push(dateInput.value);
              hiddenInput.value = JSON.stringify(arr);
              renderBadges();
            }
            dateInput.value = "";
            dateInput.style.display = "none";
          };

        } else if (index === 1 || index === 2 || index === 3) {
          // Textareas for Etria, Solutions, Meeting Summary
          const textarea = document.createElement("textarea");
          textarea.value = data[index] || "";
          textarea.oninput = function () { autoResize(this); };
          setTimeout(() => autoResize(textarea), 0);
          cell.appendChild(textarea);
        } else if (index === 4 && currentRole === "admin") {
          // Actions cell with Edit and Delete buttons
          cell.classList.add("actions-cell");

          const editBtn = document.createElement("button");
          editBtn.textContent = "Edit";
          editBtn.className = "btn btn-success btn-sm";
          editBtn.onclick = () => toggleEditRow(row, editBtn);

          const delBtn = document.createElement("button");
          delBtn.textContent = "Delete";
          delBtn.className = "btn btn-danger btn-sm";
          delBtn.onclick = () => {
            if (editingRow === row) editingRow = null;
            row.remove();
          };

          cell.appendChild(editBtn);
          cell.appendChild(delBtn);
        }
      }
      // Set this new row as the editing row
      editingRow = row;
      disableAllInputs();
    }

    function disableAllInputs() {
      const rows = document.querySelectorAll("#wsrTable tbody tr");
      rows.forEach(row => {
        if (row === editingRow) {
          row.classList.add("editing");
          setInputsDisabled(row, false);
        } else {
          row.classList.remove("editing");
          setInputsDisabled(row, true);
        }
      });
    }

    function setInputsDisabled(row, disabled) {
      const inputs = row.querySelectorAll("input, select, textarea, button");
      inputs.forEach(input => {
        // Only disable input, textarea, select; keep the "Remove" span and badges clickable.
        if (input.tagName === "INPUT" || input.tagName === "TEXTAREA" || input.tagName === "SELECT") {
          input.disabled = disabled;
          if (disabled) {
            input.style.pointerEvents = "none";
            input.style.backgroundColor = "transparent";
            input.style.border = "none";
          } else {
            input.style.pointerEvents = "auto";
            input.style.backgroundColor = "white";
            input.style.border = "1px solid #ced4da";
            input.style.borderRadius = "4px";
          }
        } else if (input.tagName === "BUTTON") {
          // Only enable Add Date button and Edit/Delete if not disabled
          input.disabled = disabled;
          if (input.textContent === "Add Date") {
            input.style.display = disabled ? "none" : "inline-block";
          }
        }
      });
      // Also hide/show the date input
      const dateInput = row.querySelector('input[type="date"]');
      if (dateInput) {
        dateInput.style.display = disabled ? "none" : "none";
      }
    }

    function toggleEditRow(row, editBtn) {
      if (editingRow && editingRow !== row) {
        disableAllInputs();
        editingRow = null;
      }

      if (editingRow === row) return;
      else {
        editingRow = row;
        disableAllInputs();
        editBtn.textContent = "Edit";
      }
    }

    function saveTable() {
      if (!confirm("Are you sure you want to save the changes?")) return;

      editingRow = null;
      disableAllInputs();

      const tbody = document.querySelector("#wsrTable tbody");
      const rows = tbody.rows;
      let dataToSave = [];
      for (let i = 0; i < rows.length; i++) {
        let rowData = [];
        const cells = rows[i].cells;
        // Week Days column (multi-date)
        const hiddenInput = cells[0].querySelector('input[type="hidden"]');
        rowData.push(JSON.parse(hiddenInput.value || "[]"));
        // Textareas
        for (let j = 1; j <= 3; j++) {
          const textarea = cells[j].querySelector("textarea");
          rowData.push(textarea ? textarea.value.trim() : "");
        }
        dataToSave.push(rowData);
      }
      localStorage.setItem("wsrData", JSON.stringify(dataToSave));
      alert("Data saved successfully.");
    }

    function loadTable() {
      const data = localStorage.getItem("wsrData");
      if (!data) return;
      const rowsData = JSON.parse(data);
      rowsData.forEach(rowData => addRow(rowData));
      editingRow = null;
      disableAllInputs();
    }

    window.onload = () => { loadTable(); };
  </script>
</body>
</html>
